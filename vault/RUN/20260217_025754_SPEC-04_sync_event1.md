# RUN LOG: SPEC-04_sync_event1

## 日時
- 2026-02-17 02:57:54

## 対象SPEC
- `vault/SPEC/SPEC-04_notion_to_github_issue_sync.md`

## 実行コマンド
1. `rg -n "TaskKey必須|冪等性|title prefix|Issue Label|Issue Body|更新許可フィールド|検索クエリテンプレート|正規表現" tools/notion_sync/README.md`
2. `python3 tools/notion_sync/event1_dry_run.py --reset-state --event tools/notion_sync/examples/event_with_taskkey.json > /tmp/event1_run1.json`
3. `python3 tools/notion_sync/event1_dry_run.py --event tools/notion_sync/examples/event_with_taskkey.json > /tmp/event1_run2.json`
4. `python3 tools/notion_sync/event1_dry_run.py --event tools/notion_sync/examples/event_missing_taskkey.json > /tmp/event1_missing.json || true`

## 検証結果
### 1) I/O契約
```text
33:### 冪等性ルール（必須）
39:### 検索クエリテンプレート（必須）
42:  - 正規表現: `^taskkey:TSK-[0-9]{8}-[0-9]{4}$`
53:- Issue Label: `taskkey:TSK-YYYYMMDD-####`
54:- Issue Body: `TaskKey: TSK-YYYYMMDD-####` を先頭セクションに記載
56:### Notion -> GitHub 更新許可フィールド（必須）
```

### 2) 同一TaskKey 2回投入
- run1: create
```text
17:  "operation": "create",
```
- run2: update
```text
17:  "operation": "update",
```

### 3) TaskKey欠落
- command exit code: 1
```text
3:  "operation": "error",
no create operation found
```

### 4) 更新対象フィールド
```text
9:- 双方向で同一フィールドを同時更新しない。
22:- `payload.priority`, `payload.due`, `payload.owner`: 受け取っても GitHub へは反映しない（Notion only）
44:  - `repo:<owner>/<repo> is:issue label:taskkey:TSK-20260217-0001`
45:  - `repo:<owner>/<repo> is:issue is:open label:taskkey:TSK-20260217-0001`
57:- 更新してよい:
58:  - `issue.title`（TaskKey prefix を含む）
59:  - `issue.body`（Summary、関連リンク、同期時刻）
60:  - `issue.labels`（`taskkey:*`, `status:*`）
61:- 更新しない:
62:  - `priority`, `due`, `owner`（Notion only）
```

### 5) 運用ログ手順
```text
tools/notion_sync/README.md:143:- 失敗時は再試行し、最終失敗は RUN ログへ記録。
docs/SYNC_POLICY.md:22:- 片方向の更新失敗時は再試行し、逆方向で補正しない。
docs/SYNC_POLICY.md:53:- 永続失敗は `vault/RUN/` へ同期障害ログを出力。
```

### 6) label厳密形式と検索クエリ
```text
44:  - `repo:<owner>/<repo> is:issue label:taskkey:TSK-20260217-0001`
```

## 変更ファイル一覧
- tools/notion_sync/event1_dry_run.py
- tools/notion_sync/examples/event_with_taskkey.json
- tools/notion_sync/examples/event_missing_taskkey.json
- tools/notion_sync/.gitignore
- tools/notion_sync/README.md
- vault/SPEC/SPEC-04_notion_to_github_issue_sync.md

## 変更理由
- Event1 を「文書のみ」から「実行可能な dry-run」へ進め、create/update/error の挙動を検証可能にするため。

## リスク
- 現時点はローカル state ベースの疑似実装であり、GitHub API 実通信は未実施。

## 次の確認事項
- Notion API payload 正規化ルールの詳細化
- Issue検索フォールバック（label以外）
- エラー分類ごとの再試行方針
